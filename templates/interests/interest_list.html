{% extends "base.html" %}
{% load static tz %}

{% include "components.html" %}

{% block title %}Manage Interests{% endblock %}

{% block content %}

<style>
  :root {
    --primary-color: #38A169;
    --bg-light: #f7f9fc;
    --text-primary: #1a202c;
    --text-muted: #4a5568;
    --card-bg: #ffffff;
    --card-shadow: rgba(0, 0, 0, 0.05);
    --btn-edit-bg: #D69E2E;
    --header-bg: #003347;
  }

  .dials-btn {
    font-size: 1rem;
    line-height: 1;
    width: 1.5em;
    height: 1.5em;
    border-radius: 0.25rem;
    border: 1px solid #cbd5e0;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s;
  }

  .status-pill {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #fff;
  }
  .status-interested {
    background-color: #2563eb;
  }

  .dials-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  .dial-btn {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 4px;
    background: #edf2f7;
    color: #4a5568;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .dial-btn:hover:not(:disabled) { background: #e2e8f0; }
  .dial-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .dial-count {
    min-width: 1ch;
    text-align: center;
    font-weight: 600;
    color: var(--text-primary);
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
    margin-bottom: 1rem;
    align-items: center;
  }
  .filter-input {
    flex: 0 0 300px;
    max-width: 220px;
    padding: 0.5rem 0.75rem;
    border: 1px solid #cbd5e0;
    border-radius: 0.375rem;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    font-size: 1rem;
  }
  .btn-filter,
  .btn-reset {
    padding: 0.3rem 1rem;
    line-height: 1.5;
    font-size: 1rem;
    border-radius: 0.375rem;
    cursor: pointer;
    border: none;
    transition: background 0.2s;
    white-space: nowrap;
  }
  .btn-filter {
    background-color: var(--primary-color);
    color: #fff;
  }
  .btn-filter:hover { background-color: #2F855A; }
  .btn-reset {
    background-color: #E2E8F0;
    color: var(--text-primary);
  }
  .btn-reset:hover { background-color: #CBD5E0; }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    
  }

  .btn-new {
    background-color: var(--primary-color);
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.2s;
  }

  .btn-new:hover { background-color: #2F855A; }

  .card {
    background: var(--card-bg);
    box-shadow: 0 2px 4px var(--card-shadow);
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
  }
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 0.5rem;
    overflow: hidden;
    margin-top: 1rem;
  }
  .table th,
  .table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
    white-space: nowrap;
  }
  .table th {
    background-color: var(--header-bg);
    color: #fff;
    font-weight: 600;
  }
  .table tbody tr:hover { background-color: #edf2f7; }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
    color: #fff;
  }
  .status-badge.connected   { background-color: #48BB78; }
  .status-badge.disconnected { background-color: #F56565; }

  .btn-edit {
    background-color: var(--btn-edit-bg);
    color: #fff;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.2s;
    white-space: nowrap;
  }
  .btn-edit:hover { background-color: #B7791F; }

  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
    gap: 0.5rem;
  }
  .pagination a,
  .pagination span {
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    text-decoration: none;
  }
  .pagination a { background-color: var(--card-bg); color: var(--text-primary); }
  .pagination a:hover { background-color: var(--bg-light); }
  .pagination .current { background-color: var(--primary-color); color: #fff; }

  .forbidden-card {
    max-width: 600px;
    margin: 3rem auto;
    padding: 1.5rem;
    background: var(--card-bg);
    box-shadow: 0 2px 4px var(--card-shadow);
    border-radius: 0.5rem;
    text-align: center;
  }
  .forbidden-card h2 { color: var(--text-primary); margin-bottom: 0.5rem; }
  .forbidden-card p { color: var(--text-muted); }
</style>

<div class="page-header">
  <h1>
    Manage Interests
    <span class="page-subtitle">
      ({{ page_obj.paginator.count }} total)
    </span>
  </h1>
  <a href="{% url 'interests:add' %}" class="btn-primary">+ New Interest</a>
</div>

<form id="filter-form" method="get" class="filter-bar">
  <input
    type="text"
    name="q"
    class="filter-input"
    placeholder="Search phone…"
    value="{{ request.GET.q }}"
  />

  <!-- Quick-range dropdown -->
  <select id="quick-range" name="quick_range" class="filter-input">
    <option value="today"     {% if request.GET.quick_range == 'today'     %}selected{% endif %}>Today</option>
    <option value="yesterday" {% if request.GET.quick_range == 'yesterday' %}selected{% endif %}>Yesterday</option>
    <option value="last7"     {% if request.GET.quick_range == 'last7'     %}selected{% endif %}>Last 7 Days</option>
    <option value="thisMonth" {% if request.GET.quick_range == 'thisMonth' %}selected{% endif %}>This Month</option>
    <option value=""          {% if not request.GET.quick_range           %}selected{% endif %}>All Dates</option>
  </select>

  <div style="display: inline-flex; align-items: center; gap: 0.25rem;">
    <label for="id_connected" style="margin: 0;">Connected?</label>
    <select id="id_connected" name="connected" class="filter-input">
      <option value=""  {% if request.GET.connected == ''  %}selected{% endif %}>All</option>
      <option value="1" {% if request.GET.connected == '1' %}selected{% endif %}>Yes</option>
      <option value="0" {% if request.GET.connected == '0' %}selected{% endif %}>No</option>
    </select>
  </div>

  <button type="submit" class="btn-filter">Filter</button>
  <a href="{% url 'interests:list' %}" class="btn-reset">Reset</a>

  <!-- Hidden inputs for date-range -->
  <input type="hidden" name="start" id="start" value="{{ request.GET.start }}">
  <input type="hidden" name="end"   id="end"   value="{{ request.GET.end }}">
</form>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Phone</th>
        <th>Attempts</th>
        <th>Connected?</th>
        <th>Status</th>
        <th>Source</th>
        <th>Mode</th>
        <th>Created By</th>
        <th>Created At</th>
        <th>Updated By</th>
        <th>Updated At</th>
        <th>Remarks</th>
        <th>Lead ID</th>
        <th>Lead Manager</th>
        <th>Dials</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for interest in object_list %}
        <tr>
          <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td>{{ interest.phone_number }}</td>
          <td>{{ interest.attempted_times }}</td>
          <td>
            {% if interest.is_connected %}
              <span class="status-badge connected">Yes</span>
            {% else %}
              <span class="status-badge disconnected">No</span>
            {% endif %}
          </td>
          <td>
            {% if interest.status.name == "Interested" %}
              <span class="status-pill status-interested">Interested</span>
            {% else %}
              {{ interest.status.name }}
            {% endif %}
          </td>
          <td>{{ interest.source.name }}</td>
          <td>{{ interest.mode.name }}</td>
          <td>{{ interest.created_by.get_full_name }}</td>
          <td>{{ interest.created_at|timezone:"Asia/Kolkata"|date:"Y-m-d H:i" }}</td>
          <td>{{ interest.updated_by.get_full_name }}</td>
          <td>{{ interest.updated_at|timezone:"Asia/Kolkata"|date:"Y-m-d H:i" }}</td>
          <td>{{ interest.remarks }}</td>
          <td>
            {% if interest.lead %}
              {{ interest.lead.pk }}
            {% else %}—{% endif %}
          </td>
          <td>
            {% if interest.lead %}
              {{ interest.lead.lead_manager.get_full_name }}
            {% else %}—{% endif %}
          </td>
          <td class="dials-cell">
            <button class="dial-btn" data-pk="{{ interest.pk }}" data-delta="-1">−</button>
            <span class="dial-count" id="dials-count-{{ interest.pk }}">{{ interest.dials }}</span>
            <button class="dial-btn" data-pk="{{ interest.pk }}" data-delta="1">＋</button>
          </td>
          <td><a href="{% url 'interests:edit' interest.pk %}" class="btn-edit">Edit</a></td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="17" class="text-center text-muted">No interests found.</td>
        </tr>
      {% endfor %}
      <meta name="csrf-token" content="{{ csrf_token }}">
    </tbody>
  </table>


{% if is_paginated %}
  <div class="pagination">
    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <span class="current">{{ num }}</span>
      {% else %}
        <a href="?page={{ num }}">{{ num }}</a>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}
</div>

<script>
  // AJAX for dials buttons
  function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').content;
  }
  document.querySelectorAll('.dial-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.preventDefault();
      const pk = btn.dataset.pk, delta = Number(btn.dataset.delta);
      try {
        const res = await fetch("{% url 'interests:adjust_dials' 0 %}".replace('/0/','/'+pk+'/'), {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({delta})
        });
        if(!res.ok) throw 0;
        const data = await res.json();
        document.getElementById(`dials-count-${pk}`).textContent = data.dials;
      } catch {
        alert('Failed to update dials');
      }
    });
  });

  // Quick-range logic
  function fmt(d){
    let y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'),
        dd=d.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  const qr = document.getElementById('quick-range'),
        today = new Date();

  qr.addEventListener('change', ()=>{
    let s,e;
    switch(qr.value){
      case 'today':      s=e=new Date(); break;
      case 'yesterday':  s=e=new Date(new Date().setDate(today.getDate()-1)); break;
      case 'last7':      e=new Date(); s=new Date(new Date().setDate(e.getDate()-6)); break;
      case 'thisMonth':  e=new Date(); s=new Date(e.getFullYear(),e.getMonth(),1); break;
      default:
        document.getElementById('start').value='';
        document.getElementById('end').value='';
        return document.getElementById('filter-form').submit();
    }
    document.getElementById('start').value = fmt(s);
    document.getElementById('end').value   = fmt(e);
    document.getElementById('filter-form').submit();
  });

  // Initialize quick-range on load
  (function(){
    const s="{{ request.GET.start }}", e="{{ request.GET.end }}";
    if(!s||!e) return;
    const sd=new Date(s), ed=new Date(e),
          diff=(ed-sd)/(1000*60*60*24);
    if(diff===0) qr.value='today';
    else if(diff===1) qr.value='yesterday';
    else if(diff===6) qr.value='last7';
    else if(sd.getDate()===1 && sd.getMonth()===today.getMonth()) qr.value='thisMonth';
    else qr.value='';
  })();
</script>
{% endblock content %}
