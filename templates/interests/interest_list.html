{% extends "base.html" %}
{% load static tz %}

{% include "components.html" %}

{% block title %}Manage Interests{% endblock %}

{% block content %}
{% include "loader.html" %}
<div id="page-content">

<div class="page-header">
  <div class="page-title">
    Manage Interests &nbsp;
    <span class="page-subtitle">
       ( {{ total_records }} Records &bull; {{ connected_count }} Connected &bull; {{ interested_count }} Interested )
    </span>
  </div>
  <a href="{% url 'interests:add' %}" class="btn btn-submit">+ New Interest</a>
</div>

<form id="filter-form" method="get" class="filter-bar">
  <input type="text" name="q" class="filter-input" placeholder="Search phone…" value="{{ request.GET.q }}" />

  <!-- Quick-range dropdown -->
  <select id="quick-range" name="quick_range" class="filter-input">
    <option value="today" {% if request.GET.quick_range == 'today' %}selected{% endif %}>Today</option>
    <option value="yesterday" {% if request.GET.quick_range == 'yesterday' %}selected{% endif %}>Yesterday</option>
    <option value="last7" {% if request.GET.quick_range == 'last7' %}selected{% endif %}>Last 7 Days</option>
    <option value="thisMonth" {% if request.GET.quick_range == 'thisMonth' %}selected{% endif %}>This Month</option>
    <option value="" {% if not request.GET.quick_range %}selected{% endif %}>Select Date Range</option>
  </select>

  <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
    <label for="id_connected" style="margin: 0;">Connected?</label>
    <select id="id_connected" name="connected" class="filter-input">
      <option value="" {% if request.GET.connected == '' %}selected{% endif %}>All</option>
      <option value="1" {% if request.GET.connected == '1' %}selected{% endif %}>Yes</option>
      <option value="0" {% if request.GET.connected == '0' %}selected{% endif %}>No</option>
    </select>

    <button type="submit" class="btn btn-filter">Filter</button>

    <button type="button" class="btn btn-filter-reset" onclick="window.location.href='{% url 'interests:list' %}'">
      Reset
    </button>

  </div>
 



  <!-- Hidden inputs for date-range -->
  <input type="hidden" name="start" id="start" value="{{ request.GET.start }}">
  <input type="hidden" name="end" id="end" value="{{ request.GET.end }}">
</form>

<div class="card">
  <div class="table-responsive">
    <table class="table" data-sticky-left="2" data-sticky-right="2">
      <thead>
        <tr>
          <th>ID</th>
          <th>Phone</th>
          <th>Attempts</th>
          <th>Connected?</th>
          <th>Status</th>
          <th>Source</th>
          <th>Mode</th>
          <th>Created By</th>
          <th>Created At</th>
          <th>Updated By</th>
          <th>Updated At</th>
          <th>Remarks</th>
          <th>Lead ID</th>
          <th>Lead Manager</th>
          <th>Dials</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for interest in object_list %}
        <tr>
          <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td>{{ interest.phone_number }}</td>

          <td>{{ interest.attempted_times }}</td>
          <td>
            {% if interest.is_connected %}
            <span class="status-badge connected">Yes</span>
            {% else %}
            <span class="status-badge disconnected">No</span>
            {% endif %}
          </td>
          <td>
            {% if interest.status.name == "Interested" %}
            <span class="status-pill status-interested">Interested</span>
            {% else %}
            {{ interest.status.name }}
            {% endif %}
          </td>
          <td>{{ interest.source.name }}</td>
          <td>{{ interest.mode.name }}</td>
          <td>{{ interest.created_by.get_full_name }}</td>
          <td>{{ interest.created_at|timezone:"Asia/Kolkata"|date:"Y-m-d H:i" }}</td>
          <td>{{ interest.updated_by.get_full_name }}</td>
          <td>{{ interest.updated_at|timezone:"Asia/Kolkata"|date:"Y-m-d H:i" }}</td>
          <td>{{ interest.remarks }}</td>
          <td>
            {% if interest.lead %}{{ interest.lead.pk }}{% else %}&mdash;{% endif %}
          </td>
          <td>
            {% if interest.lead %}{{ interest.lead.lead_manager.get_full_name }}{% else %}&mdash;{% endif %}
          </td>

          <td class="dials-cell">
            <button class="dial-btn" data-pk="{{ interest.pk }}" data-delta="-1">−</button>
            <span class="dial-count" id="dials-count-{{ interest.pk }}">{{ interest.dials }}</span>
            <button class="dial-btn" data-pk="{{ interest.pk }}" data-delta="1">＋</button>
          </td>
          <td><a href="{% url 'interests:edit' interest.pk %}" class="btn btn-edit">Edit</a></td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="17" class="text-center text-muted">No interests found.</td>
        </tr>
        {% endfor %}
        <meta name="csrf-token" content="{{ csrf_token }}">
      </tbody>
    </table>
  </div>
  {% include "includes/pagination.html" with page_obj=page_obj %}
</div>

</div>

<script>
  // AJAX for dials buttons
  function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').content;
  }
  document.querySelectorAll('.dial-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.preventDefault();
      const pk = btn.dataset.pk, delta = Number(btn.dataset.delta);
      try {
        const res = await fetch("{% url 'interests:adjust_dials' 0 %}".replace('/0/', '/' + pk + '/'), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({ delta })
        });
        if (!res.ok) throw 0;
        const data = await res.json();
        document.getElementById(`dials-count-${pk}`).textContent = data.dials;
      } catch {
        alert('Failed to update dials');
      }
    });
  });

  // Quick-range logic
  function fmt(d) {
    let y = d.getFullYear(), m = (d.getMonth() + 1).toString().padStart(2, '0'),
      dd = d.getDate().toString().padStart(2, '0');
    return `${y}-${m}-${dd}`;
  }
  const qr = document.getElementById('quick-range'),
    today = new Date();

  qr.addEventListener('change', () => {
    let s, e;
    switch (qr.value) {
      case 'today': s = e = new Date(); break;
      case 'yesterday': s = e = new Date(new Date().setDate(today.getDate() - 1)); break;
      case 'last7': e = new Date(); s = new Date(new Date().setDate(e.getDate() - 6)); break;
      case 'thisMonth': e = new Date(); s = new Date(e.getFullYear(), e.getMonth(), 1); break;
      default:
        document.getElementById('start').value = '';
        document.getElementById('end').value = '';
        return document.getElementById('filter-form').submit();
    }
    document.getElementById('start').value = fmt(s);
    document.getElementById('end').value = fmt(e);
    document.getElementById('filter-form').submit();
  });

  // Initialize quick-range on load
  (function () {
    const start = "{{ request.GET.start }}";
    const end   = "{{ request.GET.end }}";
    const quickRange = "{{ request.GET.quick_range }}";

    if (!start && !end && !quickRange) {
      const today = new Date();
      const y = today.getFullYear(),
            m = String(today.getMonth() + 1).padStart(2, '0'),
            d = String(today.getDate()).padStart(2, '0');

      document.getElementById('start').value = `${y}-${m}-${d}`;
      document.getElementById('end').value = `${y}-${m}-${d}`;
      document.getElementById('filter-form').submit();
    }
  })();

</script>

<script>
  window.addEventListener('load', function() {
    const loader = document.getElementById('page-loader');
    if (loader) loader.style.display = 'none';
  });
</script>

{% endblock content %}
